{% extends 'layout.html' %}
{% block style %}
<link rel="stylesheet" href="/css/signup.css">
{% endblock %}
{% block content %}
<div class="container">
    <div class="signup-header">
        <span><a href="/"><i class="bi bi-chevron-left"></i></a></span>
        <span class="signup-title">회원가입</span>
        <span> </span>
    </div>

    <img src="/images/colorlogo.png" alt="Logo" class="logo">

    <div id="progress-container" class="progress-container p-3">
      <div class="progress px-1" style="height: 3px;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="step-container d-flex justify-content-between">
        <div class="step-circle active" onclick="displayStep(1)">1</div>
        <div class="step-circle" onclick="displayStep(2)">2</div>
        <div class="step-circle" onclick="displayStep(3)">3</div>
      </div>
    </div>

    <form id="multi-step-form" action="/signup" method="post" class="p-3 mb-5">
      <!-- Step 1: 약관동의 -->
      <div class="step step-1">
        <div class="step-description">약관동의</div>
        <div class="mb-3">
          <label class="form-label">아이스케어 서비스<br/> 이용약관에 동의해주세요.</label>          
        </div>
        <div class="terms-container">
          <div class="all-terms-check" id="all-terms-check">
            <div class="terms-check">
              <i class="bi bi-check"></i>
            </div>
            <span>모든 약관에 동의합니다.</span>
          </div>
          <div class="terms-item">
            <div class="terms-header">
              <div class="terms-check">
                <i class="bi bi-check"></i>
              </div>
              <div class="terms-title">
                <span>서비스 이용약관 동의</span>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
            <div class="terms-content">
              본 약관은 제빙기 청소 예약 서비스 이용에 관한 기본적인 조건을 규정합니다. 
              이용자의 권리 및 의무, 서비스 제공 범위, 예약 변경 및 취소 규정 등이 포함되어 있으며, 
              서비스 이용 시 반드시 숙지하셔야 합니다.
            </div>
          </div>
          <div class="terms-item">
            <div class="terms-header">
              <div class="terms-check">
                <i class="bi bi-check"></i>
              </div>
              <div class="terms-title">
                <span>개인정보 수집 및 이용 동의</span>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
            <div class="terms-content">
              고객 식별 및 서비스 제공을 위해 이름, 연락처, 주소 등 최소한의 개인정보를 수집합니다. 
              수집된 정보는 예약 처리와 고객 응대를 위해 사용되며, 관련 법령에 따라 안전하게 보호됩니다.
            </div>
          </div>
          <div class="terms-item">
            <div class="terms-header">
              <div class="terms-check">
                <i class="bi bi-check"></i>
              </div>
              <div class="terms-title">
                <span>개인정보 제3자 제공 동의</span>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
            <div class="terms-content">
              청소 기사에게 고객의 이름, 연락처, 주소 등을 제공할 수 있습니다.
              제공된 정보는 오직 서비스 수행 목적에 한해 사용되며, 관계 법령에 따라 안전하게 처리됩니다.
            </div>
          </div>
          <div class="terms-item">
            <div class="terms-header">
              <div class="terms-check">
                <i class="bi bi-check"></i>
              </div>
              <div class="terms-title">
                <span>위치 및 개인정보 활용 동의</span>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
            <div class="terms-content">
              정확한 예약 및 기사 배정을 위해 위치 및 주소 정보를 수집·활용합니다. 
              수집된 정보는 서비스 제공 목적에 한해 사용되며, 외부에 공유되지 않고 관련 법령에 따라 보호됩니다.
              수집된 정보는 청소 예정일 알림, 할인 쿠폰, 프로모션 및 이벤트 안내를 알림을 위해 사용될 수 있습니다.
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: 회원가입 -->
      <div class="step step-2" style="display: none;">
        <div class="step-description">회원 정보를 입력해 주세요.</div>
        <div class="mb-3">
          <label for="name" class="form-label">이름</label>
          <input type="text" class="form-control" id="name" name="name" placeholder="이름" required>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">연락처</label>
          <input type="tel" class="form-control" id="phone" name="phone" required pattern="^010-\d{4}-\d{4}$" placeholder="010-1234-5678">
          <div class="invalid-feedback">연락처는 010-1234-5678 형식으로 입력해주세요.</div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">이메일</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="example@example.com" required pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
          <div class="invalid-feedback">유효한 이메일 주소를 입력해주세요.</div>
        </div>
        <div class="mb-3">
          <label FOR="password" class="form-label">비밀번호</label>
          <input type="password" class="form-control" id="password" name="password" placeholder="비밀번호" required pattern="^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*()])[a-zA-Z\d!@#$%^&*()]{8,}$" title="비밀번호는 영문, 숫자, 특수문자를 포함해 8자 이상이어야 합니다.">
          <div class="invalid-feedback">비밀번호는 영문, 숫자, 특수문자(!@#$%^&*())를 포함해 8자 이상이어야 합니다.</div>
        </div>
        <div class="mb-3">
          <label for="password_confirm" class="form-label">비밀번호 확인</label>
          <input type="password" class="form-control" id="password_confirm" name="password_confirm" required>
          <div id="password-confirm-feedback" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
          <label for="address" class="form-label">주소</label>
          <div class="row g-2">
            <div class="col-9">
              <input type="text" class="form-control" id="postcode" name="postcode" placeholder="우편번호" readonly>
            </div>
            <div class="col-3">
              <button type="button" class="btn btn-primary w-100" onclick="openAddressSearch()">검색</button>
            </div>
          </div>
          <input type="text" class="form-control mt-2" id="address" name="address" placeholder="주소" readonly>
          <input type="text" class="form-control mt-2" id="address_detail" name="address_detail" placeholder="상세주소">
        </div>
      </div>

      <!-- Step 3: 가입완료 -->
      <div class="step step-3" style="display: none;">
        <div class="step-description">가입이 완료되었습니다!</div>
        <div class="text-center mb-3">
          <p>환영합니다! 지금 로그인하여 서비스를 이용해 보세요.</p>
          <!-- <a href="/" class="btn btn-success">로그인 하러 가기</a> -->
        </div>
      </div>
    </form>

    <div class="btn-container mb-2">
      <button type="button" class="btn btn-outline-primary prev-step" style="display: none;">이전</button>
      <button type="button" class="btn btn-primary next-step">다음</button>
    </div>
</div>
{% endblock %}
{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
var currentStep = 1;
let phoneCheckTimeout;

// 부트스트랩 모달을 이용한 카카오 주소 검색
function openAddressSearch() {
  // 기존 모달 제거
  let existModal = document.getElementById('addressModal');
  if (existModal) existModal.remove();

  // 모달 HTML 생성 (reservation.html과 동일한 스타일)
  const modalHtml = `
    <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered d-flex justify-content-center" style="max-width:95vw;">
        <div class="modal-content" style="min-height:400px; max-width:34rem;">
          <div class="modal-header">
            <h5 class="modal-title" id="addressModalLabel">주소 검색</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body" style="padding:0;">
            <div id="daum-postcode-embed" style="width:100%;height:400px;"></div>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // 부트스트랩 모달 인스턴스 생성 및 표시
  var addressModal = new bootstrap.Modal(document.getElementById('addressModal'), {
    backdrop: 'static',
    keyboard: false
  });
  addressModal.show();

  // 카카오 주소 검색 위젯 삽입
  new daum.Postcode({
    oncomplete: function(data) {
      document.querySelector('input[name="postcode"]').value = data.zonecode;
      document.querySelector('input[name="address"]').value = data.address;
      document.querySelector('input[name="address_detail"]').focus();
      addressModal.hide();
      setTimeout(() => {
        // 모달 DOM 제거 (메모리 누수 방지)
        let m = document.getElementById('addressModal');
        if (m) m.remove();
      }, 300);
    },
    width: '100%',
    height: '100%',
    animation: true
  }).embed(document.getElementById('daum-postcode-embed'));

  // 모달 닫힐 때 위젯도 제거
  document.getElementById('addressModal').addEventListener('hidden.bs.modal', function () {
    let m = document.getElementById('addressModal');
    if (m) m.remove();
  });
}

// 연락처 포맷팅 
function formatPhoneNumber(value) {
  
  const numbers = value.replace(/\D/g, '');
  
  if (numbers.startsWith('010')) {
    if (numbers.length <= 3) {
      return numbers;
    } else if (numbers.length <= 7) {
      return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
    } else {
      return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
    }
  }
  return value; 
}

// 전화번호 중복체크
function checkPhoneDuplicate(phone) {
  console.log('전화번호 중복체크 시작');
  console.log('phone',phone);

  if (phone.length < 13) return; 
  
  clearTimeout(phoneCheckTimeout);
  phoneCheckTimeout = setTimeout(() => {
    console.log('전화번호 중복체크 setTimeout');
    axios.get('/signup/check-phone', {
      params: { phone: phone }
    })
    .then(function(response) {
      console.log('전화번호 중복체크 응답',response.data);
      if (response.data.isDuplicate) {
        $('#phone').addClass('is-invalid');
        $('#phone').next('.invalid-feedback').text(response.data.message);
      } else {
        $('#phone').removeClass('is-invalid');
        $('#phone').next('.invalid-feedback').text('');
      }
    })
    .catch(function(error) {
      console.error('전화번호 중복체크 오류:', error);
    });
  }, 500);
}

function displayStep(stepNumber) {
  if (stepNumber >= 1 && stepNumber <= 3) {
    $(".step").hide();
    $(".step-" + stepNumber).show();
    currentStep = stepNumber;
    updateProgressBar();
    updateStepCircles();
    updateButtons();
  }
}

function updateStepCircles() {
  $(".step-circle").removeClass("active");
  $(".step-circle").eq(currentStep - 1).addClass("active");
}

function updateProgressBar() {
  var progressPercentage = ((currentStep - 1) / 2) * 100;
  $(".progress-bar").css("width", progressPercentage + "%");
}

function updateButtons() {
  $(".btn-container .btn-success").remove();
  
  if (currentStep === 1) {
    $(".prev-step").hide();
    $(".next-step").show().text("다음");
  } else if (currentStep === 2) {
    $(".prev-step").show();
    $(".next-step").show().text("회원가입");
  } else if (currentStep === 3) {
    $(".prev-step").hide();
    $(".next-step").hide();
    if (!$(".btn-container .btn-success").length) {
      $(".btn-container").append('<a href="/" class="btn btn-success">로그인 하러 가기</a>');
    }
  }
}

$(document).ready(function() {
  $(".step").slice(1).hide();
  updateStepCircles();
  updateButtons();
  
  // 연락처 실시간 포맷팅 및 검증
  $('#phone').on('input', function() {
    const $this = $(this);
    let value = $this.val();
    value = formatPhoneNumber(value);
    $this.val(value);

    const phoneRegex = /^010-\d{4}-\d{4}$/;
    if (value && !phoneRegex.test(value)) {
      $this.addClass('is-invalid');
    } else {
      $this.removeClass('is-invalid');
      if (phoneRegex.test(value)) {
        checkPhoneDuplicate(value);
      }
    }
  });

  // 이메일 실시간 검증
  $('#email').on('input', function() {
    const email = $(this).val();
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (email && !emailRegex.test(email)) {
      $(this).addClass('is-invalid');
    } else {
      $(this).removeClass('is-invalid');
    }
  });

  // 이메일 중복체크
  let emailCheckTimeout;
  $('#email').on('input', function() {
    const $this = $(this);
    let value = $this.val().trim();
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    if (value && !emailRegex.test(value)) {
      $this.addClass('is-invalid');
    } else {
      $this.removeClass('is-invalid');

      if (emailRegex.test(value)) {
        clearTimeout(emailCheckTimeout);
        emailCheckTimeout = setTimeout(() => {
          axios.get('/signup/check-email', {
            params: { email: value }
          })
          .then(function(response) {
            if (response.data.isDuplicate) {
              $this.addClass('is-invalid');
              $this.next('.invalid-feedback').text(response.data.message);
            } else {
              $this.removeClass('is-invalid');
              $this.next('.invalid-feedback').text('');
            }
          })
          .catch(function(error) {
            console.error('이메일 중복체크 오류:', error);
          });
        }, 500); 
      }
    }
  });

   // 비밀번호 실시간 검증
   $('#password, #password_confirm').on('input', function() {
    const password = $('#password').val();
    const passwordConfirm = $('#password_confirm').val();
    const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*()])[a-zA-Z\d!@#$%^&*()]{8,}$/;

    // 비밀번호 복잡성 검증
    if (password && !passwordRegex.test(password)) {
      $('#password').addClass('is-invalid');
    } else {
      $('#password').removeClass('is-invalid');
    }

    // 비밀번호 확인 복잡성 검증
    if (passwordConfirm && !passwordRegex.test(passwordConfirm)) {
      $('#password_confirm').addClass('is-invalid');
      $('#password-confirm-feedback').text('비밀번호는 영문, 숫자, 특수문자(!@#$%^&*())를 포함해 8자 이상이어야 합니다.');
    } else if (passwordConfirm && password !== passwordConfirm) {
      $('#password_confirm').addClass('is-invalid');
      $('#password-confirm-feedback').text('비밀번호가 일치하지 않습니다.');
    } else if (passwordConfirm) {
      $('#password_confirm').removeClass('is-invalid');
      $('#password-confirm-feedback').text('');
    }
  });


  $(".next-step").click(function() {
    if (currentStep === 1) {
      
      // 약곤동의 체크 확인
      const allTermsChecked = $('#all-terms-check .terms-check').hasClass('checked');
      if (!allTermsChecked) {
        alert("약관에 동의해 주세요.");
        return;
      }

      // Step 1에서 다음 단계로 이동
      $(".step-" + currentStep).addClass("animate__animated animate__fadeOutLeft");
      currentStep++;
      setTimeout(function() {
        $(".step").removeClass("animate__animated animate__fadeOutLeft").hide();
        $(".step-" + currentStep).show().addClass("animate__animated animate__fadeInRight");
        updateProgressBar();
        updateStepCircles();
        updateButtons();
      }, 500);
    } else if (currentStep === 2) {
      // Step 2에서 폼 유효성 검사 및 제출
      const form = $("#multi-step-form")[0];
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // 비밀번호 복잡성 및 일치 여부 확인
      const password = $('input[name="password"]').val();
      const passwordConfirm = $('input[name="password_confirm"]').val();
      const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*()])[a-zA-Z\d!@#$%^&*()]{8,}$/;

      if (!passwordRegex.test(password)) {
        alert("비밀번호는 영문, 숫자, 특수문자(!@#$%^&*())를 포함해 8자 이상이어야 합니다.");
        $('#password').addClass('is-invalid');
        return;
      }

      if (!passwordRegex.test(passwordConfirm)) {
        alert("비밀번호 확인은 영문, 숫자, 특수문자(!@#$%^&*())를 포함해 8자 이상이어야 합니다.");
        $('#password_confirm').addClass('is-invalid');
        $('#password-confirm-feedback').text('비밀번호는 영문, 숫자, 특수문자(!@#$%^&*())를 포함해 8자 이상이어야 합니다.');
        return;
      }

      if (password !== passwordConfirm) {
        alert("비밀번호가 일치하지 않습니다.");
        $('#password_confirm').addClass('is-invalid');
        $('#password-confirm-feedback').text('비밀번호가 일치하지 않습니다.');
        return;
      }

      // 전화번호 중복 여부 확인
      if ($('#phone').hasClass('is-invalid')) {
        alert("전화번호를 확인해주세요.");
        return;
      }

      console.log('Axios 요청 시작');
      console.log('폼 데이터:', $("#multi-step-form").serialize());
      
      // 폼 데이터를 서버로 전송
      axios.post('/signup', $("#multi-step-form").serialize(), {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      })
      .then(function(response) {
        console.log('서버 응답:', response.data);
        console.log('응답 메시지:', response.data.message);
        console.log('메시지 비교 결과:', response.data.message === '회원가입 성공');
        
        // 성공 응답인지 확인
        if (response.data && (response.data.message === '회원가입 성공' || !response.data.error)) {
          console.log('회원가입 성공 - Step 3로 이동 시작');
          $(".step").hide();
          $(".step-3").show();
          currentStep = 3;
          updateProgressBar();
          updateStepCircles();
          updateButtons();
          console.log('Step 3 이동 완료');
        } else {
          alert(response.data.error || "회원가입에 실패했습니다.");
        }
      })
      .catch(function(error) {
        console.log('Axios 에러:', error);
        alert("서버 오류: " + (error.response?.data?.error || "회원가입에 실패했습니다."));
      });
    }
  });

  // 이전 버튼
  $(".prev-step").click(function() {
    if (currentStep > 1) {
      $(".step-" + currentStep).addClass("animate__animated animate__fadeOutRight");
      currentStep--;
      setTimeout(function() {
        $(".step").removeClass("animate__animated animate__fadeOutRight").hide();
        $(".step-" + currentStep).show().addClass("animate__animated animate__fadeInLeft");
        updateProgressBar();
        updateStepCircles();
        updateButtons();
      }, 500);
    }
  });

  // 약관 체크박스 
  $('.terms-title').click(function() {
    const $termsItem = $(this).closest('.terms-item');
    const $check = $termsItem.find('.terms-check');
    $check.toggleClass('checked');
    updateAllTermsCheck();
  });

  $('.terms-check').click(function(e) {
    e.stopPropagation();
    const $termsItem = $(this).closest('.terms-item');
    const $check = $termsItem.find('.terms-check');
    $check.toggleClass('checked');
    updateAllTermsCheck();
  });

  $('.bi-chevron-right, .bi-chevron-down').click(function(e) {
    e.stopPropagation();
    const $termsItem = $(this).closest('.terms-item');
    const $content = $termsItem.find('.terms-content');
    const $chevron = $(this);
    
    $content.toggleClass('show');
    $chevron.toggleClass('bi-chevron-right bi-chevron-down');
  });


  // 전체동의 
  $('#all-terms-check').click(function() {
    const $allCheck = $(this);
    const isChecked = !$allCheck.hasClass('checked');
    
    $allCheck.toggleClass('checked');
    $('.terms-check').toggleClass('checked', isChecked);
  });

  function updateAllTermsCheck() {
    const allChecked = $('.terms-item .terms-check').length === $('.terms-item .terms-check.checked').length;
    $('#all-terms-check .terms-check').toggleClass('checked', allChecked);
  }
});

</script>
{% endblock %}